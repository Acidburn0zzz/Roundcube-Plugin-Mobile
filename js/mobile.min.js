/* Copyright (C) 2015  PNE Annuaire et Messagerie/MEDDE */

function show_uploadform(){var e=$("#upload-dialog");if(e.is(":visible")){e.dialog("close");return}if(rcmail.env.action=="compose"&&!e.data("extended")){$("<a>").addClass("iconlink add").attr("href","#add").html("Add").appendTo($('input[type="file"]',e).parent()).click(add_uploadfile);e.data("extended",true)}e.dialog({modal:true,resizable:false,closeOnEscape:true,title:e.attr("title"),close:function(){try{$("#upload-dialog form").get(0).reset()}catch(t){}e.dialog("destroy").hide();$("div.addline",e).remove()},width:480}).show();if(!document.all)$("input[type=file]",e).first().click()}function add_uploadfile(e){var t=$(this).parent();var n=t.clone().addClass("addline").insertAfter(t);n.children(".iconlink").click(add_uploadfile);n.children("input").val("");if(!document.all)$("input[type=file]",n).click()}function show_header_row(e,t){var n=$("#compose-"+e);if(n.is(":visible"))return;if(compose_headers[e]&&!t)$("#_"+e).val(compose_headers[e]);n.show();$("#"+e+"-link").hide();return false}function hide_header_row(e){var t=$("#_"+e);compose_headers[e]=t.val();t.val("");$("#compose-"+e).hide();$("#"+e+"-link").show();return false}function toggleFullScreen(){var e=window.document;var t=e.documentElement;var n=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen||t.msRequestFullscreen;var r=e.exitFullscreen||e.mozCancelFullScreen||e.webkitExitFullscreen||e.msExitFullscreen;if(!e.fullscreenElement&&!e.mozFullScreenElement&&!e.webkitFullscreenElement&&!e.msFullscreenElement){n.call(t);setTimeout(function(){window.scrollTo(0,1)},100)}else{r.call(e)}}var page_loading;var current_page_scroll;var current_uid;var previous_page;var timer,show_timer,checkmail_timer,touchstart_timer;var storePosition={topCoordinate:null};$(document).on("pagecreate",".jqm-calendar",function(){$(document).on("swipeleft swiperight","#calendar",function(e){if(e.type==="swipeleft"){$("#calendar").fullCalendar("next")}else{$("#calendar").fullCalendar("prev")}});$("html").keydown(function(e){if(e.which==37){$("#calendar").fullCalendar("prev")}else if(e.which==39){$("#calendar").fullCalendar("next")}})});$(document).on("pageshow","#page_mail_list",function(){if(window.storePosition.topCoordinate!==null){$.mobile.silentScroll(window.storePosition.topCoordinate)}});$(document).on("click","#messagelist a",function(){e.stopPropagation();return false});$(document).on("pageshow","#page_addressbook_list",function(){if(window.storePosition.topCoordinate!==null){$.mobile.silentScroll(window.storePosition.topCoordinate)}});$(document).on("pageshow",".jqm-message",function(){$("#buttons-right-panel a").click(function(){setTimeout(function(){$("#folder-selector").css({left:($(document).width()-$("#folder-selector").width())/2,top:50});$("#buttons-right-panel").panel("close")},50)});if(!window.current_uid){return}$(".jqm-message").css({left:0});$(".jqm_message_list_group").show();$(".rc_message_back").hide();$("#mail-list-left-panel").html($("#page_mail_list .ui-content").html());$("#mail-list-left-panel #mailboxmenu").remove();$("#mail-list-left-panel #jqm-mail-newmessage-button").remove();if(window.storePosition.topCoordinate!==null){$("#mail-list-left-panel").scrollTop(window.storePosition.topCoordinate)}$("#mail-list-left-panel").bind("scroll",function(){if($(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight){var e=current_page_scroll;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=true;var t=rcmail.set_busy(true,"loading");var n={};n._mbox=rcmail.env.mailbox;n._page=e;if(rcmail.env.search_request)n._search=rcmail.env.search_request;rcmail.http_request("list",n,t)}}});rcmail.env.uid=window.current_uid;rcmail.env.action="show";jQuery.each(rcmail.env.messages[window.current_uid].flags.tb_labels,function(e,t){rcm_tb_label_flag_msgs([-1],t)});var e=["show","reply","reply-all","reply-list","move","copy","delete","open","mark","edit","viewsource","print","load-attachment","download-attachment","show-headers","hide-headers","download","forward","forward-inline","forward-attachment","change-format"];rcmail.enable_command(e,rcmail.env.uid);$("#countcontrols").hide();rcmail.addEventListener("responseafterlist",function(e){$("#mail-list-left-panel").html($("#page_mail_list .ui-content").html());$("#mail-list-left-panel #mailboxmenu").remove();$("#mail-list-left-panel #jqm-mail-newmessage-button").remove()});rcmail.addEventListener("actionafter",function(e){if(e.action=="mark"){if(e.props=="unread"){rcmail.set_message(rcmail.env.uid,"unread",true)}else if(e.props=="read"){rcmail.set_message(rcmail.env.uid,"unread",false)}else{return}if($.mobile.pageContainer.pagecontainer("getActivePage")[0].id!="page_mail_list"){if(window.previous_page=="page_mail_list"){$.mobile.back()}else{$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))}}}});rcmail.addEventListener("responseaftermove",function(e){window.previous_page="current_page";if($.mobile.pageContainer.pagecontainer("getActivePage")[0].id!="page_mail_list"){if(window.previous_page=="page_mail_list"){$.mobile.back()}else{$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))}}});rcmail.addEventListener("responseafterdelete",function(e){window.previous_page="current_page";if($.mobile.pageContainer.pagecontainer("getActivePage")[0].id!="page_mail_list"){if(window.previous_page=="page_mail_list"){$.mobile.back()}else{$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))}}})});$(document).on("pagecreate",".jqm-message",function(){if(window.previous_page){$(".jqm_message_list").click(function(e){if(window.previous_page=="page_mail_list"){window.previous_page="current_page";$.mobile.back()}else{window.previous_page="current_page";$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))}e.preventDefault()});$("#attachment-list li a").click(function(){$(this).attr("target","_blank");$(this).attr("onlick","")});$(".image-attachment a").click(function(){$(this).attr("target","_blank");$(this).attr("onlick","")});$(".zipdownload").hide()}});$(document).on("pageshow",".jqm-contact",function(){if(!window.current_uid){return}$(".jqm_contact_list_group").show();$(".rc_contact_back").hide();$("#contact-list-left-panel").html($("#page_addressbook_list .ui-content").html());$("#contact-list-left-panel .searchbox").hide();rcmail.env.cid=window.current_uid;rcmail.env.action="show";rcmail.enable_command("show","edit",true);if(window.storePosition.topCoordinate!==null){$("#contact-list-left-panel").scrollTop(window.storePosition.topCoordinate)}$("input.groupmember").change(function(){rcmail.group_member_change(this.checked?"add":"del",rcmail.env.cid,rcmail.env.source,this.value)});$("#contact-list-left-panel").bind("scroll",function(){if($(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight){var e=rcmail.env.current_page+1;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=true;var t=rcmail.set_busy(true,"loading");var n={};n._source=rcmail.env.source;if(rcmail.env.group)n._gid=rcmail.env.group;n._page=e;if(rcmail.env.search_request)n._search=rcmail.env.search_request;rcmail.http_request_mobile("list",n,t,function(){rcmail.env.current_page=e},function(){})}}});rcmail.addEventListener("responseafterlist",function(e){$("#contact-list-left-panel").html($("#page_addressbook_list .ui-content").html());$("#contact-list-left-panel .searchbox").hide()})});$(document).on("pagecreate",".jqm-contact",function(){if(window.previous_page){var e=true;$(document).on("swipeleft swiperight",".jqm-contact",function(t){if(!e){return}if(t.type==="swiperight"){$("#contact-list-left-panel").panel("open")}e=false;setTimeout(function(){e=true},900)});$(".jqm_contact_list").click(function(e){if(window.previous_page=="page_addressbook_list"){window.previous_page="current_page";$.mobile.back()}else{window.previous_page="current_page";$.mobile.pageContainer.pagecontainer("change",$("#page_addressbook_list"))}e.preventDefault()});$(".contactcontrollerphone .contactfieldcontent.text").each(function(){$(this).html('<a href="tel:'+$(this).html()+'">'+$(this).html()+"</a>")});rcmail.register_command("delete_mobile",rcmail.delete_contact_mobile,!rcmail.env.readonly)}});$(document).on("pageloadfailed",function(e,t){e.preventDefault()});$(document).ready(function(){$("#mailboxlist").attr("data-role","listview");$("#mailboxlist ul").attr("data-role","listview");$("#mailboxlist ul").show();$("#mailboxlist li").attr("data-icon","false");$("#mailboxlist div.treetoggle").hide();$("#quicksearchbox").attr("placeholder","Search...");$("#quicksearchbox").attr("data-type","search");$("#directorylist_mobile").attr("data-role","listview");$("#directorylist_mobile ul").attr("data-role","listview");$("#directorylist_mobile ul").show();$("#directorylist_mobile > li").attr("data-icon","user");$("#directorylist_mobile li li").attr("data-icon","false");$("#directorylist_mobile div.treetoggle").hide();$("#calendarslist").attr("data-role","listview");$("#calendarslist ul").attr("data-role","listview");$("#calendarslist div.treetoggle").hide();if($("#eventedit").length){$("#eventedit .edit-alarm-type").selectmenu()}});if(window.rcmail){rcmail.addEventListener("init",function(e){page_loading={};current_page_scroll=1;$("#select_balp_mobile").change(function(){window.location=$("#select_balp_mobile option:selected").val()});$(".button-switch_desktop").click(function(){setTimeout(function(){window.location="?_task=mail"},3e3)});if(window.location.href.indexOf("?_task=addressbook&_orig_source=")!=-1&&!rcmail.env.cid){window.location="?_task=addressbook&_source="+window.location.href.split("?_task=addressbook&_orig_source=").pop()}if(rcmail.env.task=="mail"&&(!rcmail.env.action||rcmail.env.action=="")){var t=false;$(".ui-title").html($("#mailboxlist li.selected a").first().clone().children().remove().end().text());$(window).resize(function(){$("#mailview-left-panel").panel("refresh");$("#mailview-left-panel").panel("close")});$("#mailboxlist li a").click(function(){$("#mailview-left-panel").panel("close");$(".ui-title").html($(this).clone().children().remove().end().text());$("#mailboxlist").listview("refresh")});$(".jqm-mail-cancel-searchbox").click(function(){$(".jqm-mail-header").show();$(".jqm-mail-search-header").hide()});$(".jqm-mail-open-searchbox").click(function(){$(".jqm-mail-header").hide();$(".jqm-mail-search-header").show();$(".jqm-mail-search-header input").focus()});$("#quicksearchbox").click(function(){$("#quicksearchbox").focus()});$(document).scroll(function(){if($.mobile.pageContainer.pagecontainer("getActivePage")[0].id!="page_mail_list"){return}if($(window).scrollTop()>200&&($(window).scrollTop()+$(window).height())/$(document).height()>=.95&&current_page_scroll>1){var e=current_page_scroll;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=true;var t=rcmail.set_busy(true,"loading");var n={};n._mbox=rcmail.env.mailbox;n._page=e;if(rcmail.env.search_request)n._search=rcmail.env.search_request;rcmail.http_request("list",n,t)}}});rcmail.message_list.addEventListener("clear",function(e){page_loading={};rcmail.env.current_page=1;current_page_scroll=2})}else if(rcmail.env.task=="mail"&&rcmail.env.action=="compose"){$(".button_upload_photo").click(function(){$("#upload-popup").popup("close")});rcmail.env.compose_commands=["send-attachment","remove-attachment","send","cancel","toggle-editor","list-adresses","pushgroup","search","reset-search","extwin","insert-response","save-response"];if(rcmail.env.drafts_mailbox)rcmail.env.compose_commands.push("savedraft");rcmail.enable_command(rcmail.env.compose_commands,"identities","responses",true);rcmail.addEventListener("aftersend-attachment",show_uploadform).addEventListener("add-recipient",function(e){show_header_row(e.field,true)});var n,r,i,s=["cc","bcc","replyto","followupto"];for(n=0;n<s.length;n++){r=s[n];i=$("#_"+r);if(i.length){i.on("change",{v:r},function(e){if(this.value)show_header_row(e.data.v,true)});if(i.val()!="")show_header_row(r,true)}}}else if(rcmail.env.task=="mail"&&rcmail.env.action=="show"){$(".mark_as_read").click(function(){$("#buttons-right-panel").panel("close")});$(".mark_as_unread").click(function(){$("#buttons-right-panel").panel("close")});$("#bounce_button_mobile").click(function(){$("#buttons-right-panel").panel("close")})}else if(rcmail.env.task=="addressbook"&&(!rcmail.env.action||rcmail.env.action=="")){$(".ui-title").html($("#directorylist_mobile li.selected a").first().text());$("#directorylist_mobile li.selected a").first().addClass("ui-btn ui-btn-icon-right ui-icon-check");$(window).resize(function(){$("#addressbook-left-panel").panel("close")});$("#directorylist_mobile li a").click(function(){$("#addressbook-left-panel").panel("close");$("#directorylist_mobile li a").removeClass("ui-btn-active");page_loading={};rcmail.env.current_page=1;$(".ui-title").html($(this).clone().children().remove().end().text());$("#directorylist_mobile").listview("refresh")});$("#quicksearchbox").click(function(){$("#quicksearchbox").focus()});$(window).scroll(function(){if($(window).scrollTop()>200&&($(window).scrollTop()+$(window).height())/$(document).height()>=.95){var e=rcmail.env.current_page+1;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=true;var t=rcmail.set_busy(true,"loading");var n={};n._source=rcmail.env.source;if(rcmail.env.group)n._gid=rcmail.env.group;n._page=e;if(rcmail.env.search_request)n._search=rcmail.env.search_request;rcmail.http_request_mobile("list",n,t,function(){rcmail.env.current_page=e},function(){})}}});rcmail.contact_list.addEventListener("clear",function(e){page_loading={};rcmail.env.current_page=1})}else if(rcmail.env.task=="addressbook"&&rcmail.env.action=="show"){$(".contactcontrollerphone .contactfieldcontent.text").each(function(){$(this).html('<a href="tel:'+$(this).html()+'">'+$(this).html()+"</a>")});rcmail.register_command("delete_mobile",rcmail.delete_contact_mobile,!rcmail.env.readonly)}else if(rcmail.env.task=="addressbook"&&rcmail.env.action=="edit"){$("select.addfieldmenu").change(function(){$("#contacttabs").trigger("create")});$(".button_upload_photo").click(function(){$("#upload-popup").popup("close")})}else if(rcmail.env.task=="calendar"){$(window).resize(function(){$("#calendarview-left-panel").panel("close")});$(window).hashchange(function(e){var t=e.originalEvent.oldURL.split("#").pop();if(t){switch(t){case"event_show_dialog":$("#eventshow:ui-dialog").dialog("close");break;case"event_edit_dialog":$("#eventeditdialog:ui-dialog").dialog("close");break;case"eventeditpage":$.mobile.pageContainer.pagecontainer("change","./?_task=calendar");break}}})}if(rcmail.message_list){var o=window.rcmail;rcmail.message_list.addEventListener("click",function(e){window.clearTimeout(window.show_timer);window.storePosition.topCoordinate=$(window).scrollTop();window.previous_page="page_mail_list";o.msglist_dbl_click_mobile(e);e.preventDefault()});rcmail.message_list.addEventListener("dblclick",function(e){window.clearTimeout(window.show_timer);window.storePosition.topCoordinate=$(window).scrollTop();window.previous_page="page_mail_list";o.msglist_dbl_click_mobile(e);e.preventDefault()})}if(rcmail.contact_list){var o=window.rcmail;rcmail.contact_list.addEventListener("click",function(e){window.previous_page="page_addressbook_list";window.storePosition.topCoordinate=$(window).scrollTop();o.contactlist_select_mobile(e)}).addEventListener("dragstart",function(e){return false}).addEventListener("dragmove",function(e){return false}).addEventListener("dragend",function(e){return false})}});rcmail.addEventListener("responseafterlist",function(e){current_page_scroll=rcmail.env.current_page+1;rcmail.env.current_page=1;rcmail.http_post("plugin.set_current_page",{})})}rcube_webmail.prototype.http_request_mobile=function(e,t,n,r,i){var s=this.url(e,t);var o=this;var u=this.triggerEvent("request"+e,t);if(u!==undefined){if(u===false)return false;else s=this.url(e,u)}s+="&_remote=1";this.log("HTTP GET: "+s);this.start_keepalive();return $.ajax({type:"GET",url:s,data:{_unlock:n?n:0},dataType:"json",success:function(e){o.http_response(e);r()},error:function(t,r,s){o.http_error(t,r,s,n,e);i()}})};rcube_webmail.prototype.delete_contact_mobile=function(){if(rcmail.env.readonly||!confirm(rcmail.get_label("deletecontactconfirm")))return;var e="contactdeleting",t="delete";post_data={};post_data._source=rcmail.env.source;post_data._from=rcmail.env.action;post_data._cid=rcmail.env.cid;lock=rcmail.display_message(rcmail.get_label(e),"loading");if(rcmail.env.group)post_data._gid=rcmail.env.group;if(rcmail.env.search_request)post_data._search=rcmail.env.search_request;rcmail.http_post(t,post_data,lock);window.location="?_task="+rcmail.env.task+"&_source="+rcmail.env.source;return true};rcube_webmail.prototype.msglist_dbl_click_mobile=function(e){if(this.preview_timer)clearTimeout(this.preview_timer);if(this.preview_read_timer)clearTimeout(this.preview_read_timer);var t=e.get_single_selection();e.clear_selection();window.current_uid=t;this.set_message(t,"unread",false);if(t&&this.env.mailbox==this.env.drafts_mailbox)this.open_compose_step({_draft_uid:t,_mbox:this.env.mailbox});else if(t)this.show_message_mobile(t,{})};rcube_webmail.prototype.show_message_mobile=function(e,t){if(!e)return;$("#messagelist li").removeClass("selected");$("#messagelist li#rcmrow"+e).addClass("selected");var n,r=window,i="show",s="&_action="+i+"&_uid="+e+"&_mbox="+urlencode(this.env.mailbox);if(this.env.search_request)s+="&_search="+this.env.search_request;s+="&_caps="+urlencode(this.browser_capabilities());if(this.env.extwin)s+="&_extwin=1";$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+s,t)};rcube_webmail.prototype.contactlist_select_mobile=function(e){if(this.preview_timer)clearTimeout(this.preview_timer);var t,n,r,i,s=this,o=false,u=this.env.source?this.env.address_sources[this.env.source]:null;if(n=e.get_single_selection())s.load_contact_mobile(n,"show");window.current_uid=n;this.enable_command("group-remove-selected",this.env.group&&e.selection.length>0&&o);this.enable_command("compose",this.env.group||e.selection.length>0);this.enable_command("export-selected","copy",e.selection.length>0);this.enable_command("edit",n&&o);this.enable_command("delete","move",e.selection.length>0&&o);return false};rcube_webmail.prototype.load_contact_mobile=function(e,t,n){var r,i="",s=window,o=this.contact_list?this.contact_list.data[e]:null;if(t&&(e||t=="add")&&!this.drag_active){$("#contacts-table tr").removeClass("selected");$("#contacts-table tr#rcmrow"+e).addClass("selected");i="&_action="+t;if(this.env.search_request)i+="&_search="+this.env.search_request;i+="&_source="+this.env.source;i+="&_cid="+e;$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+i,{})}return true};var compose_headers={}