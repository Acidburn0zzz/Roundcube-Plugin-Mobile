/**
 * Plugin Mobile for Roundcube
 *
 * Add new skin mobile to Roundcube
 * 
 * Javascript mobile file
 *
 * Copyright (C) 2015  PNE Annuaire et Messagerie/MEDDE
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author PNE Annuaire et Messagerie/MEDDE
 * @license GNU GPLv3+
 *
 */

function show_uploadform(){var e=$("#upload-dialog");return e.is(":visible")?void e.dialog("close"):("compose"!=rcmail.env.action||e.data("extended")||($("<a>").addClass("iconlink add").attr("href","#add").html("Add").appendTo($('input[type="file"]',e).parent()).click(add_uploadfile),e.data("extended",!0)),e.dialog({modal:!0,resizable:!1,closeOnEscape:!0,title:e.attr("title"),close:function(){try{$("#upload-dialog form").get(0).reset()}catch(t){}e.dialog("destroy").hide(),$("div.addline",e).remove()},width:480}).show(),void(document.all||$("input[type=file]",e).first().click()))}function add_uploadfile(){var e=$(this).parent(),t=e.clone().addClass("addline").insertAfter(e);t.children(".iconlink").click(add_uploadfile),t.children("input").val(""),document.all||$("input[type=file]",t).click()}function show_header_row(e,t){var i=$("#compose-"+e);if(!i.is(":visible"))return compose_headers[e]&&!t&&$("#_"+e).val(compose_headers[e]),i.show(),$("#"+e+"-link").hide(),!1}function hide_header_row(e){var t=$("#_"+e);return compose_headers[e]=t.val(),t.val(""),$("#compose-"+e).hide(),$("#"+e+"-link").show(),!1}function toggleFullScreen(){var e=window.document,t=e.documentElement,i=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen||t.msRequestFullscreen,a=e.exitFullscreen||e.mozCancelFullScreen||e.webkitExitFullscreen||e.msExitFullscreen;e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement?a.call(e):(i.call(t),setTimeout(function(){window.scrollTo(0,1)},100))}var page_loading,current_page_scroll,current_uid,previous_page,timer,show_timer,checkmail_timer,touchstart_timer,storePosition={topCoordinate:null};$(document).on("pagecreate",".jqm-calendar",function(){$(document).on("swipeleft swiperight","#calendar",function(e){$("#calendar").fullCalendar("swipeleft"===e.type?"next":"prev")}),$("html").keydown(function(e){37==e.which?$("#calendar").fullCalendar("prev"):39==e.which&&$("#calendar").fullCalendar("next")})}),$(document).on("pageshow","#page_mail_list",function(){null!==window.storePosition.topCoordinate&&$.mobile.silentScroll(window.storePosition.topCoordinate)}),$(document).on("click","#messagelist a",function(e){return e.preventDefault(),!1}),$(document).on("pageshow","#page_addressbook_list",function(){null!==window.storePosition.topCoordinate&&$.mobile.silentScroll(window.storePosition.topCoordinate)}),$(document).on("pageshow",".jqm-message",function(){if($("#buttons-right-panel a").click(function(){setTimeout(function(){$("#folder-selector").css({left:($(document).width()-$("#folder-selector").width())/2,top:50}),$("#buttons-right-panel").panel("close")},50)}),window.current_uid){$(".jqm-message").css({left:0}),$(".jqm_message_list_group").show(),$(".rc_message_back").hide(),$("#mail-list-left-panel").html($("#page_mail_list .ui-content").html()),$("#mail-list-left-panel #mailboxmenu").remove(),$("#mail-list-left-panel #jqm-mail-newmessage-button").remove(),null!==window.storePosition.topCoordinate&&$("#mail-list-left-panel").scrollTop(window.storePosition.topCoordinate),$("#mail-list-left-panel").bind("scroll",function(){if($(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight){var e=current_page_scroll;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=!0;var t=rcmail.set_busy(!0,"loading"),i={};i._mbox=rcmail.env.mailbox,i._page=e,rcmail.env.search_request&&(i._search=rcmail.env.search_request),rcmail.http_request("list",i,t)}}}),rcmail.env.uid=window.current_uid,rcmail.env.action="show",rcmail.env.messages[window.current_uid].flags&&jQuery.each(rcmail.env.messages[window.current_uid].flags.tb_labels,function(e,t){rcm_tb_label_flag_msgs([-1],t)});var e=["show","reply","reply-all","reply-list","move","copy","delete","open","mark","edit","viewsource","print","load-attachment","download-attachment","show-headers","hide-headers","download","forward","forward-inline","forward-attachment","change-format"];rcmail.enable_command(e,rcmail.env.uid),$("#countcontrols").hide(),rcmail.addEventListener("responseafterlist",function(){$("#mail-list-left-panel").html($("#page_mail_list .ui-content").html()),$("#mail-list-left-panel #mailboxmenu").remove(),$("#mail-list-left-panel #jqm-mail-newmessage-button").remove()}),rcmail.addEventListener("actionafter",function(e){if("mark"==e.action){if("unread"==e.props)rcmail.set_message(rcmail.env.uid,"unread",!0);else{if("read"!=e.props)return;rcmail.set_message(rcmail.env.uid,"unread",!1)}"page_mail_list"!=$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&("page_mail_list"==window.previous_page?$.mobile.back():$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list")))}}),rcmail.addEventListener("responseaftermove",function(){window.previous_page="current_page","page_mail_list"!=$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&("page_mail_list"==window.previous_page?$.mobile.back():$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list")))}),rcmail.addEventListener("responseafterdelete",function(){window.previous_page="current_page","page_mail_list"!=$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&("page_mail_list"==window.previous_page?$.mobile.back():$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list")))})}}),$(document).on("pagecreate",".jqm-message",function(){window.previous_page&&($(".jqm_message_list").click(function(e){"page_mail_list"==window.previous_page?(window.previous_page="current_page",$.mobile.back(),$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))):(window.previous_page="current_page",$.mobile.pageContainer.pagecontainer("change",$("#page_mail_list"))),e.preventDefault()}),$("#attachment-list li a").click(function(){$(this).attr("target","_blank"),$(this).attr("onlick","")}),$(".image-attachment a").click(function(){$(this).attr("target","_blank"),$(this).attr("onlick","")}),$(".zipdownload").hide())}),$(document).on("pageshow",".jqm-contact",function(){window.current_uid&&($(".jqm_contact_list_group").show(),$(".rc_contact_back").hide(),$("#contact-list-left-panel").html($("#page_addressbook_list .ui-content").html()),$("#contact-list-left-panel .searchbox").hide(),rcmail.env.cid=window.current_uid,rcmail.env.action="show",rcmail.enable_command("show","edit",!0),null!==window.storePosition.topCoordinate&&$("#contact-list-left-panel").scrollTop(window.storePosition.topCoordinate),$("input.groupmember").change(function(){rcmail.group_member_change(this.checked?"add":"del",rcmail.env.cid,rcmail.env.source,this.value)}),$("#contact-list-left-panel").bind("scroll",function(){if($(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight){var e=rcmail.env.current_page+1;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=!0;var t=rcmail.set_busy(!0,"loading"),i={};i._source=rcmail.env.source,rcmail.env.group&&(i._gid=rcmail.env.group),i._page=e,rcmail.env.search_request&&(i._search=rcmail.env.search_request),rcmail.http_request_mobile("list",i,t,function(){rcmail.env.current_page=e},function(){})}}}),rcmail.addEventListener("responseafterlist",function(){$("#contact-list-left-panel").html($("#page_addressbook_list .ui-content").html()),$("#contact-list-left-panel .searchbox").hide()}))}),$(document).on("pagecreate",".jqm-contact",function(){if(window.previous_page){var e=!0;$(document).on("swipeleft swiperight",".jqm-contact",function(t){e&&("swiperight"===t.type&&$("#contact-list-left-panel").panel("open"),e=!1,setTimeout(function(){e=!0},900))}),$(".jqm_contact_list").click(function(e){"page_addressbook_list"==window.previous_page?(window.previous_page="current_page",$.mobile.back()):(window.previous_page="current_page",$.mobile.pageContainer.pagecontainer("change",$("#page_addressbook_list"))),e.preventDefault()}),$(".contactcontrollerphone .contactfieldcontent.text").each(function(){$(this).html('<a href="tel:'+$(this).html()+'">'+$(this).html()+"</a>")}),rcmail.register_command("delete_mobile",rcmail.delete_contact_mobile,!rcmail.env.readonly)}}),$(document).on("pageloadfailed",function(e){e.preventDefault()}),$(document).ready(function(){$("#mailboxlist").attr("data-role","listview"),$("#mailboxlist ul").attr("data-role","listview"),$("#mailboxlist ul").show(),$("#mailboxlist li").attr("data-icon","false"),$("#mailboxlist div.treetoggle").hide(),$("#quicksearchbox").attr("placeholder","Search..."),$("#quicksearchbox").attr("data-type","search"),$("#directorylist_mobile").attr("data-role","listview"),$("#directorylist_mobile ul").attr("data-role","listview"),$("#directorylist_mobile ul").show(),$("#directorylist_mobile > li").attr("data-icon","user"),$("#directorylist_mobile li li").attr("data-icon","false"),$("#directorylist_mobile div.treetoggle").hide(),$("#calendarslist").attr("data-role","listview"),$("#calendarslist ul").attr("data-role","listview"),$("#calendarslist div.treetoggle").hide(),$("#eventedit").length&&$("#eventedit .edit-alarm-type").selectmenu()}),window.rcmail&&(rcmail.addEventListener("init",function(){if(page_loading={},current_page_scroll=1,$("#select_balp_mobile").change(function(){window.location=$("#select_balp_mobile option:selected").val()}),$(".button-switch_desktop").click(function(){setTimeout(function(){window.location="?_task=mail"},3e3)}),-1==window.location.href.indexOf("?_task=addressbook&_orig_source=")||rcmail.env.cid||(window.location="?_task=addressbook&_source="+window.location.href.split("?_task=addressbook&_orig_source=").pop()),"mail"!=rcmail.env.task||rcmail.env.action&&""!=rcmail.env.action)if("mail"==rcmail.env.task&&"compose"==rcmail.env.action){$(".button_upload_photo").click(function(){$("#upload-popup").popup("close")}),rcmail.env.compose_commands=["send-attachment","remove-attachment","send","cancel","toggle-editor","list-adresses","pushgroup","search","reset-search","extwin","insert-response","save-response"],rcmail.env.drafts_mailbox&&rcmail.env.compose_commands.push("savedraft"),rcmail.enable_command(rcmail.env.compose_commands,"identities","responses",!0),rcmail.addEventListener("aftersend-attachment",show_uploadform).addEventListener("add-recipient",function(e){show_header_row(e.field,!0)});var e,t,i,a=["cc","bcc","replyto","followupto"];for(e=0;e<a.length;e++)t=a[e],i=$("#_"+t),i.length&&(i.on("change",{v:t},function(e){this.value&&show_header_row(e.data.v,!0)}),""!=i.val()&&show_header_row(t,!0))}else"mail"==rcmail.env.task&&"show"==rcmail.env.action?($(".mark_as_read").click(function(){$("#buttons-right-panel").panel("close")}),$(".mark_as_unread").click(function(){$("#buttons-right-panel").panel("close")}),$("#bounce_button_mobile").click(function(){$("#buttons-right-panel").panel("close")})):"addressbook"!=rcmail.env.task||rcmail.env.action&&""!=rcmail.env.action?"addressbook"==rcmail.env.task&&"show"==rcmail.env.action?($(".contactcontrollerphone .contactfieldcontent.text").each(function(){$(this).html('<a href="tel:'+$(this).html()+'">'+$(this).html()+"</a>")}),rcmail.register_command("delete_mobile",rcmail.delete_contact_mobile,!rcmail.env.readonly)):"addressbook"==rcmail.env.task&&"edit"==rcmail.env.action?($("select.addfieldmenu").change(function(){$("#contacttabs").trigger("create")}),$(".button_upload_photo").click(function(){$("#upload-popup").popup("close")})):"calendar"==rcmail.env.task&&($(window).resize(function(){$("#calendarview-left-panel").panel("close")}),$(window).hashchange(function(e){var t=e.originalEvent.oldURL.split("#").pop();if(t)switch(t){case"event_show_dialog":$("#eventshow:ui-dialog").dialog("close");break;case"event_edit_dialog":$("#eventeditdialog:ui-dialog").dialog("close");break;case"eventeditpage":$.mobile.pageContainer.pagecontainer("change","./?_task=calendar")}})):($(".ui-title").html($("#directorylist_mobile li.selected a").first().text()),$("#directorylist_mobile li.selected a").first().addClass("ui-btn ui-btn-icon-right ui-icon-check"),$(window).resize(function(){$("#addressbook-left-panel").panel("close")}),$("#directorylist_mobile li a").click(function(){$("#addressbook-left-panel").panel("close"),$("#directorylist_mobile li a").removeClass("ui-btn-active"),page_loading={},rcmail.env.current_page=1,$(".ui-title").html($(this).clone().children().remove().end().text()),$("#directorylist_mobile").listview("refresh")}),$("#quicksearchbox").off("focusin"),$(window).scroll(function(){if($(window).scrollTop()>200&&($(window).scrollTop()+$(window).height())/$(document).height()>=.95){var e=rcmail.env.current_page+1;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=!0;var t=rcmail.set_busy(!0,"loading"),i={};i._source=rcmail.env.source,rcmail.env.group&&(i._gid=rcmail.env.group),i._page=e,rcmail.env.search_request&&(i._search=rcmail.env.search_request),rcmail.http_request_mobile("list",i,t,function(){rcmail.env.current_page=e},function(){})}}}),rcmail.contact_list.addEventListener("clear",function(){page_loading={},rcmail.env.current_page=1}));else{$(".ui-title").html($("#mailboxlist li.selected a").first().clone().children().remove().end().text()),$(window).resize(function(){$("#mailview-left-panel").panel("refresh"),$("#mailview-left-panel").panel("close")}),$("#mailboxlist li a").click(function(){$("#mailview-left-panel").panel("close"),$(".ui-title").html($(this).clone().children().remove().end().text()),$("#mailboxlist").listview("refresh")}),$(".jqm-mail-cancel-searchbox").click(function(){$(".jqm-mail-header").show(),$(".jqm-mail-search-header").hide()}),$(".jqm-mail-open-searchbox").click(function(){$(".jqm-mail-header").hide(),$(".jqm-mail-search-header").show(),$(".jqm-mail-search-header input").focus()}),$("#quicksearchbox").off("focusin"),$(document).scroll(function(){if("page_mail_list"==$.mobile.pageContainer.pagecontainer("getActivePage")[0].id&&$(window).scrollTop()>200&&($(window).scrollTop()+$(window).height())/$(document).height()>=.95&&current_page_scroll>1){var e=current_page_scroll;if(e>0&&e<=rcmail.env.pagecount&&!page_loading[e]){page_loading[e]=!0;var t=rcmail.set_busy(!0,"loading"),i={};i._mbox=rcmail.env.mailbox,i._page=e,rcmail.env.search_request&&(i._search=rcmail.env.search_request),rcmail.http_request("list",i,t)}}}),rcmail.message_list.addEventListener("clear",function(){page_loading={},rcmail.env.current_page=1,current_page_scroll=2})}if(rcmail.message_list){var o=window.rcmail;rcmail.message_list.addEventListener("click",function(e){window.clearTimeout(window.show_timer),window.storePosition.topCoordinate=$(window).scrollTop(),window.previous_page="page_mail_list",o.msglist_dbl_click_mobile(e)}),rcmail.message_list.addEventListener("dblclick",function(e){window.clearTimeout(window.show_timer),window.storePosition.topCoordinate=$(window).scrollTop(),window.previous_page="page_mail_list",o.msglist_dbl_click_mobile(e)})}if(rcmail.contact_list){var o=window.rcmail;rcmail.contact_list.addEventListener("click",function(e){window.previous_page="page_addressbook_list",window.storePosition.topCoordinate=$(window).scrollTop(),o.contactlist_select_mobile(e)}).addEventListener("dragstart",function(){return!1}).addEventListener("dragmove",function(){return!1}).addEventListener("dragend",function(){return!1})}}),rcmail.addEventListener("responseafterlist",function(){current_page_scroll=rcmail.env.current_page+1,rcmail.env.current_page=1,rcmail.http_post("mobile.set_current_page",{})})),rcube_webmail.prototype.http_request_mobile=function(e,t,i,a,o){var n=this.url(e,t),l=this,r=this.triggerEvent("request"+e,t);if(void 0!==r){if(r===!1)return!1;n=this.url(e,r)}return n+="&_remote=1",this.log("HTTP GET: "+n),this.start_keepalive(),$.ajax({type:"GET",url:n,data:{_unlock:i?i:0},dataType:"json",success:function(e){l.http_response(e),a()},error:function(t,a,n){l.http_error(t,a,n,i,e),o()}})},rcube_webmail.prototype.delete_contact_mobile=function(){if(!rcmail.env.readonly&&confirm(rcmail.get_label("deletecontactconfirm"))){var e="contactdeleting",t="delete";return post_data={},post_data._source=rcmail.env.source,post_data._from=rcmail.env.action,post_data._cid=rcmail.env.cid,lock=rcmail.display_message(rcmail.get_label(e),"loading"),rcmail.env.group&&(post_data._gid=rcmail.env.group),rcmail.env.search_request&&(post_data._search=rcmail.env.search_request),rcmail.http_post(t,post_data,lock),window.location="?_task="+rcmail.env.task+"&_source="+rcmail.env.source,!0}},rcube_webmail.prototype.msglist_dbl_click_mobile=function(e){this.preview_timer&&clearTimeout(this.preview_timer),this.preview_read_timer&&clearTimeout(this.preview_read_timer);var t=e.get_single_selection();e.clear_selection(),window.current_uid=t,this.set_message(t,"unread",!1),t&&this.env.mailbox==this.env.drafts_mailbox?this.open_compose_step({_draft_uid:t,_mbox:this.env.mailbox}):t&&this.show_message_mobile(t,{})},rcube_webmail.prototype.show_message_mobile=function(e,t){if(e){$("#messagelist li").removeClass("selected"),$("#messagelist li#rcmrow"+e).addClass("selected");var i=(window,"show"),a="&_action="+i+"&_uid="+e+"&_mbox="+urlencode(this.env.mailbox);this.env.search_request&&(a+="&_search="+this.env.search_request),a+="&_caps="+urlencode(this.browser_capabilities()),this.env.extwin&&(a+="&_extwin=1"),$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+a,t)}},rcube_webmail.prototype.contactlist_select_mobile=function(e){this.preview_timer&&clearTimeout(this.preview_timer);{var t,i=this,a=!1;this.env.source?this.env.address_sources[this.env.source]:null}return(t=e.get_single_selection())&&i.load_contact_mobile(t,"show"),window.current_uid=t,this.enable_command("group-remove-selected",this.env.group&&e.selection.length>0&&a),this.enable_command("compose",this.env.group||e.selection.length>0),this.enable_command("export-selected","copy",e.selection.length>0),this.enable_command("edit",t&&a),this.enable_command("delete","move",e.selection.length>0&&a),!1},rcube_webmail.prototype.load_contact_mobile=function(e,t){{var i="";window,this.contact_list?this.contact_list.data[e]:null}return!t||!e&&"add"!=t||this.drag_active||($("#contacts-table tr").removeClass("selected"),$("#contacts-table tr#rcmrow"+e).addClass("selected"),i="&_action="+t,this.env.search_request&&(i+="&_search="+this.env.search_request),i+="&_source="+this.env.source,i+="&_cid="+e,$.mobile.pageContainer.pagecontainer("change",this.env.comm_path+i,{})),!0};var compose_headers={};