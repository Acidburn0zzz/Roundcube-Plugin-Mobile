/**
 * Plugin Mobile for Roundcube
 *
 * Add new skin mobile to Roundcube
 * 
 * Javascript gesture file
 *
 * Copyright (C) 2015  PNE Annuaire et Messagerie/MEDDE
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author PNE Annuaire et Messagerie/MEDDE
 * @license GNU GPLv3+
 *
 */
function getCoord(e,t){return/touch/.test(e.type)?(e.originalEvent||e).changedTouches[0]["page"+t]:e["page"+t]}function setTap(){tap=!0,setTimeout(function(){tap=!1},500)}function open_message_from_left_panel(e){e!=window.current_uid&&(rcmail.set_message(e,"unread",!1),window.current_uid=e,window.previous_page="current_page",storePosition.topCoordinate=$("#mail-list-left-panel").scrollTop(),rcmail.show_message_mobile(window.current_uid,{}))}var startX,startY,tap,swipePanelLeft,swipePanelRight,swipePage,swipeMessage,swipe_timer,tapTimer,isTapHold;$(document).on("touchstart","#mail-list-left-panel #messagelist li",function(e){startX=getCoord(e,"X"),startY=getCoord(e,"Y")}).on("touchend","#mail-list-left-panel #messagelist li",function(e){Math.abs(getCoord(e,"X")-startX)<20&&Math.abs(getCoord(e,"Y")-startY)<20&&(e.preventDefault(),open_message_from_left_panel($(document.getElementById($(this).attr("id"))).data("uid"))),setTap()}).on("click","#mail-list-left-panel #messagelist li",function(e){tap||open_message_from_left_panel($(document.getElementById($(this).attr("id"))).data("uid")),e.preventDefault()}),$(document).on("touchstart",".ui-content",function(e){startX=getCoord(e,"X"),startY=getCoord(e,"Y"),30>startX&&$(".ui-panel.ui-panel-position-left").length?(swipePanelLeft=!0,swipePanelRight=!1,swipePage=!1):startX>$(document).width()-30&&$(".ui-panel.ui-panel-position-right").length&&(swipePanelLeft=!1,swipePanelRight=!0,swipePage=!1)}).on("touchend",".ui-content",function(e){Math.abs(getCoord(e,"Y")-startY)<50&&Math.abs(getCoord(e,"X")-startX)>50&&swipePanelLeft?(e.preventDefault(),$(".ui-panel.ui-panel-position-left").panel("open"),swipePanelLeft=!1,swipePanelRight=!1,swipePage=!1):Math.abs(getCoord(e,"Y")-startY)<50&&Math.abs(startX-getCoord(e,"X"))>50&&swipePanelRight&&(e.preventDefault(),$(".ui-panel.ui-panel-position-right").panel("open"),swipePanelLeft=!1,swipePanelRight=!1,swipePage=!1)}),$(document).on("touchstart",".jqm-message .ui-content",function(e){startX=getCoord(e,"X"),startY=getCoord(e,"Y"),startX>80&&startX<$(document).width()-80&&(swipePanelLeft=!1,swipePanelRight=!1,swipePage=!0)}).on("touchmove",".jqm-message .ui-content",function(e){if(Math.abs(getCoord(e,"Y")-startY)>80&&swipePage)swipePage=!1,$(".jqm-message").css({left:0}),$("#slide-message").hide(),$("#slide-message").removeAttr("style");else if(Math.abs(getCoord(e,"Y")-startY)<80&&swipePage&&Math.abs(getCoord(e,"X")-startX)>20){if(e.preventDefault(),!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().length&&startX>getCoord(e,"X"))return $(".jqm-message").css({left:0}),$("#slide-message").hide(),void $("#slide-message").removeAttr("style");if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().length&&startX<getCoord(e,"X"))return $(".jqm-message").css({left:0}),$("#slide-message").hide(),void $("#slide-message").removeAttr("style");$("#slide-message").removeAttr("style"),startX>getCoord(e,"X")?($("#slide-message h2.subject").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().find("span.subject").text()),$("#slide-message table.headers-table-slide td.from span.adr").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().find("span.from span.adr span").text()),$("#slide-message table.headers-table-slide td.date").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().find("span.date").text()),$("#slide-message").css({right:startX-getCoord(e,"X")-$(window).width()})):($("#slide-message h2.subject").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().find("span.subject").text()),$("#slide-message table.headers-table-slide td.from span.adr").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().find("span.from span.adr span").text()),$("#slide-message table.headers-table-slide td.date").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().find("span.date").text()),$("#slide-message").css({left:getCoord(e,"X")-startX-$(window).width()})),$("#slide-message").show(),$(".jqm-message").css({left:getCoord(e,"X")-startX}),window.swipe_timer&&window.clearTimeout(window.swipe_timer),window.swipe_timer=setTimeout(function(){$(".jqm-message").css({left:0}),$("#slide-message").hide(),$("#slide-message").removeAttr("style"),swipePage=!1},2e3)}}).on("touchend",".jqm-message .ui-content",function(e){if(swipePage){if(Math.abs(getCoord(e,"X")-startX)<$(window).width()/2)$(".jqm-message").css({left:0}),$("#slide-message").hide(),$("#slide-message").removeAttr("style");else{if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().length&&startX>getCoord(e,"X"))return $(".jqm-message").css({left:0}),$("#slide-message").hide(),void $("#slide-message").removeAttr("style");if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().length&&startX<getCoord(e,"X"))return $(".jqm-message").css({left:0}),$("#slide-message").hide(),void $("#slide-message").removeAttr("style");$(".jqm-message").css({left:$(document).width()}),startX>getCoord(e,"X")?($("#slide-message").css({right:0}),open_message_from_left_panel($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().attr("id").replace("rcmrow",""))):startX<getCoord(e,"X")&&($("#slide-message").css({left:0}),open_message_from_left_panel($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().attr("id").replace("rcmrow","")))}e.preventDefault()}else $(".jqm-message").css({left:0})}),$(document).on("touchstart",".jqm-mail #messagelist li",function(e){startX=getCoord(e,"X"),startY=getCoord(e,"Y"),startX>30&&startX<$(document).width()-30&&(swipePanelLeft=!1,swipePanelRight=!1,swipePage=!1,swipeMessage=!0)}).on("touchmove",".jqm-mail #messagelist li",function(e){var t=$(this).find("div.slide_to_delete"),s=$(this).find("div.slide_to_mark");if(Math.abs(getCoord(e,"Y")-startY)>80&&swipeMessage)swipeMessage=!1,$(this).css({left:0}),t.remove(),s.remove();else if(Math.abs(getCoord(e,"Y")-startY)<80&&swipeMessage&&Math.abs(getCoord(e,"X")-startX)>35){if(!t.length&&getCoord(e,"X")-startX<0){$(this).append('<div class="slide_to_delete"></div>');var t=$(this).find("div.slide_to_delete")}else if(!s.length&&getCoord(e,"X")-startX>0){$(this).append('<div class="slide_to_mark"></div>');var s=$(this).find("div.slide_to_mark")}e.preventDefault(),getCoord(e,"X")-startX<0?(s.length||s.remove(),t.css({width:startX-getCoord(e,"X")-20,right:-(startX-getCoord(e,"X"))}),$(this).css({left:getCoord(e,"X")-startX}),t.html(Math.abs(getCoord(e,"X")-startX)>1*$(window).width()/2?rcmail.gettext("mobile.release to delete message"):rcmail.gettext("mobile.slide to delete message"))):(t.length||t.remove(),s.css({width:getCoord(e,"X")-startX-20,left:-(getCoord(e,"X")-startX)}),$(this).css({left:getCoord(e,"X")-startX}),s.html(Math.abs(getCoord(e,"X")-startX)>1*$(window).width()/3?$(this).hasClass("unread")?rcmail.gettext("mobile.release to mark as read"):rcmail.gettext("mobile.release to mark as unread"):$(this).hasClass("unread")?rcmail.gettext("mobile.slide to mark as read"):rcmail.gettext("mobile.slide to mark as unread"))),window.swipe_timer&&window.clearTimeout(window.swipe_timer);var i=$(this);window.swipe_timer=setTimeout(function(){var e=i.find("div.slide_to_delete");e.remove();var t=i.find("div.slide_to_mark");t.remove(),i.css({left:0}),swipeMessage=!1},800)}}).on("touchend",".jqm-mail #messagelist li",function(e){var t=$(this).find("div.slide_to_delete"),s=$(this).find("div.slide_to_mark");swipeMessage&&(swipeMessage=!1,window.clearTimeout(window.swipe_timer),Math.abs(getCoord(e,"X")-startX)>1*$(window).width()/2&&t.length?(rcmail.message_list.clear_selection(),rcmail.message_list.select($(this).attr("id").replace("rcmrow","")),rcmail.delete_messages(),rcmail.message_list.clear_selection()):Math.abs(getCoord(e,"X")-startX)>1*$(window).width()/3&&s.length&&($(this).hasClass("unread")?rcmail.mark_message("read",$(this).attr("id").replace("rcmrow","")):rcmail.mark_message("unread",$(this).attr("id").replace("rcmrow",""))),e.preventDefault()),s.remove(),t.remove(),$(this).css({left:0})});