/* Copyright (C) 2015  PNE Annuaire et Messagerie/MEDDE */

function getCoord(e,t){return/touch/.test(e.type)?(e.originalEvent||e).changedTouches[0]["page"+t]:e["page"+t]}function setTap(){tap=true;setTimeout(function(){tap=false},500)}function open_message_from_left_panel(e){if(e!=window.current_uid){rcmail.set_message(e,"unread",false);window.current_uid=e;window.previous_page="current_page";storePosition.topCoordinate=$("#mail-list-left-panel").scrollTop();rcmail.show_message_mobile(window.current_uid,{})}}var startX,startY,tap,swipePanelLeft,swipePanelRight,swipePage,swipeMessage,swipe_timer,tapTimer,isTapHold;$(document).on("touchstart","#mail-list-left-panel #messagelist li",function(e){startX=getCoord(e,"X");startY=getCoord(e,"Y")}).on("touchend","#mail-list-left-panel #messagelist li",function(e){if(Math.abs(getCoord(e,"X")-startX)<20&&Math.abs(getCoord(e,"Y")-startY)<20){e.preventDefault();open_message_from_left_panel($(this).attr("id").replace("rcmrow",""))}setTap()}).on("click","#mail-list-left-panel #messagelist li",function(e){if(!tap){open_message_from_left_panel($(this).attr("id").replace("rcmrow",""))}e.preventDefault()});$(document).on("touchstart",".ui-content",function(e){startX=getCoord(e,"X");startY=getCoord(e,"Y");if(startX<30&&$(".ui-panel.ui-panel-position-left").length){swipePanelLeft=true;swipePanelRight=false;swipePage=false}else if(startX>$(document).width()-30&&$(".ui-panel.ui-panel-position-right").length){swipePanelLeft=false;swipePanelRight=true;swipePage=false}}).on("touchend",".ui-content",function(e){if(Math.abs(getCoord(e,"Y")-startY)<50&&Math.abs(getCoord(e,"X")-startX)>50&&swipePanelLeft){e.preventDefault();$(".ui-panel.ui-panel-position-left").panel("open");swipePanelLeft=false;swipePanelRight=false;swipePage=false}else if(Math.abs(getCoord(e,"Y")-startY)<50&&Math.abs(startX-getCoord(e,"X"))>50&&swipePanelRight){e.preventDefault();$(".ui-panel.ui-panel-position-right").panel("open");swipePanelLeft=false;swipePanelRight=false;swipePage=false}});$(document).on("touchstart",".jqm-message .ui-content",function(e){startX=getCoord(e,"X");startY=getCoord(e,"Y");if(startX>80&&startX<$(document).width()-80){swipePanelLeft=false;swipePanelRight=false;swipePage=true}}).on("touchmove",".jqm-message .ui-content",function(e){if(Math.abs(getCoord(e,"Y")-startY)>80&&swipePage){swipePage=false;$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style")}else if(Math.abs(getCoord(e,"Y")-startY)<80&&swipePage&&Math.abs(getCoord(e,"X")-startX)>20){e.preventDefault();if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().length&&startX>getCoord(e,"X")){$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style");return}else if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().length&&startX<getCoord(e,"X")){$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style");return}$("#slide-message").removeAttr("style");if(startX>getCoord(e,"X")){$("#slide-message h2.subject").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().find("span.subject").text());$("#slide-message table.headers-table-slide td.from span.adr").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().find("span.from span.adr span").text());$("#slide-message table.headers-table-slide td.date").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().find("span.date").text());$("#slide-message").css({right:startX-getCoord(e,"X")-$(window).width()})}else{$("#slide-message h2.subject").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().find("span.subject").text());$("#slide-message table.headers-table-slide td.from span.adr").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().find("span.from span.adr span").text());$("#slide-message table.headers-table-slide td.date").html($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().find("span.date").text());$("#slide-message").css({left:getCoord(e,"X")-startX-$(window).width()})}$("#slide-message").show();$(".jqm-message").css({left:getCoord(e,"X")-startX});if(window.swipe_timer){window.clearTimeout(window.swipe_timer)}window.swipe_timer=setTimeout(function(){$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style");swipePage=false},2e3)}}).on("touchend",".jqm-message .ui-content",function(e){if(swipePage){if(Math.abs(getCoord(e,"X")-startX)<$(window).width()/2){$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style")}else{if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().length&&startX>getCoord(e,"X")){$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style");return}else if(!$("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().length&&startX<getCoord(e,"X")){$(".jqm-message").css({left:0});$("#slide-message").hide();$("#slide-message").removeAttr("style");return}$(".jqm-message").css({left:$(document).width()});if(startX>getCoord(e,"X")){$("#slide-message").css({right:0});open_message_from_left_panel($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).next().attr("id").replace("rcmrow",""))}else if(startX<getCoord(e,"X")){$("#slide-message").css({left:0});open_message_from_left_panel($("#mail-list-left-panel #messagelist li#rcmrow"+window.current_uid).prev().attr("id").replace("rcmrow",""))}}e.preventDefault()}else{$(".jqm-message").css({left:0})}});$(document).on("touchstart",".jqm-mail #messagelist li",function(e){startX=getCoord(e,"X");startY=getCoord(e,"Y");if(startX>30&&startX<$(document).width()-30){swipePanelLeft=false;swipePanelRight=false;swipePage=false;swipeMessage=true}}).on("touchmove",".jqm-mail #messagelist li",function(e){var t=$(this).find("div.slide_to_delete");var n=$(this).find("div.slide_to_mark");if(Math.abs(getCoord(e,"Y")-startY)>80&&swipeMessage){swipeMessage=false;$(this).css({left:0});t.remove();n.remove()}else if(Math.abs(getCoord(e,"Y")-startY)<80&&swipeMessage&&Math.abs(getCoord(e,"X")-startX)>35){if(!t.length&&getCoord(e,"X")-startX<0){$(this).append('<div class="slide_to_delete"></div>');var t=$(this).find("div.slide_to_delete")}else if(!n.length&&getCoord(e,"X")-startX>0){$(this).append('<div class="slide_to_mark"></div>');var n=$(this).find("div.slide_to_mark")}e.preventDefault();if(getCoord(e,"X")-startX<0){if(!n.length){n.remove()}t.css({width:startX-getCoord(e,"X")-20,right:-(startX-getCoord(e,"X"))});$(this).css({left:getCoord(e,"X")-startX});if(Math.abs(getCoord(e,"X")-startX)>$(window).width()*1/2){t.html(rcmail.gettext("mobile.release to delete message"))}else{t.html(rcmail.gettext("mobile.slide to delete message"))}}else{if(!t.length){t.remove()}n.css({width:getCoord(e,"X")-startX-20,left:-(getCoord(e,"X")-startX)});$(this).css({left:getCoord(e,"X")-startX});if(Math.abs(getCoord(e,"X")-startX)>$(window).width()*1/3){if($(this).hasClass("unread")){n.html(rcmail.gettext("mobile.release to mark as read"))}else{n.html(rcmail.gettext("mobile.release to mark as unread"))}}else{if($(this).hasClass("unread")){n.html(rcmail.gettext("mobile.slide to mark as read"))}else{n.html(rcmail.gettext("mobile.slide to mark as unread"))}}}if(window.swipe_timer){window.clearTimeout(window.swipe_timer)}var r=$(this);window.swipe_timer=setTimeout(function(){var e=r.find("div.slide_to_delete");e.remove();var t=r.find("div.slide_to_mark");t.remove();r.css({left:0});swipeMessage=false},800)}}).on("touchend",".jqm-mail #messagelist li",function(e){var t=$(this).find("div.slide_to_delete");var n=$(this).find("div.slide_to_mark");if(swipeMessage){swipeMessage=false;window.clearTimeout(window.swipe_timer);if(Math.abs(getCoord(e,"X")-startX)>$(window).width()*1/2&&t.length){rcmail.message_list.clear_selection();rcmail.message_list.select($(this).attr("id").replace("rcmrow",""));rcmail.delete_messages();rcmail.message_list.clear_selection()}else if(Math.abs(getCoord(e,"X")-startX)>$(window).width()*1/3&&n.length){if($(this).hasClass("unread")){rcmail.mark_message("read",$(this).attr("id").replace("rcmrow",""))}else{rcmail.mark_message("unread",$(this).attr("id").replace("rcmrow",""))}}e.preventDefault()}n.remove();t.remove();$(this).css({left:0})})